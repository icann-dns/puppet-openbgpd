#
# This file is managed by Puppet. DO NOT EDIT.
#
 <%- 
@no_export = false 
@nets = []
if @enable_advertisements then
  if ! @failover_server then
    if @enable_advertisements_v4 then
      @nets += @networks4
    end
    if @enable_advertisements_v6 then
      @nets += @networks6
    end
  end
  if @enable_advertisements_v4 then
    @nets += @failsafe_networks4
  end
  if @enable_advertisements_v6 then
    @nets += @failsafe_networks6
  end
end
@fail_nets = @failsafe_networks4 + @failsafe_networks6
 -%>
AS <%= @my_asn %>
router-id <%= @router_id %>
<%- unless @fib_update -%>
fib-update no
<%- end -%>
<%- @nets.each do |net| -%>
network <%= net %>
<%- end -%>
<% @peers.each_pair do |as, config| -%>
group "AS<%= as %>" {
  remote-as <%= as %>
  <%- if config.has_key?('multihop') then -%>
  multihop <%= config['multihop'] %>
  <%- end -%>
  <%- if config.has_key?('prepend') then -%>
  set prepend-self <%= config['prepend'] %>
  <%- end -%>
  <%- if config.has_key?('addr6') then -%>
    <%- config['addr6'].each do |addr| -%>
      <%- if addr then -%>
  neighbor "<%= addr %>" {
    descr "<%= config['desc'] %>"
      <%-if config['default_originate'] -%>
    announce default-route
      <%- end -%>
  }
      <%- end -%>
    <%- end -%>
  <%- end -%>
  <%- if config.has_key?('addr4') then -%>
    <%- config['addr4'].each do |addr| -%>
      <%- if addr then -%>
  neighbor "<%= addr %>" {
    descr "<%= config['desc'] %>"
      <%-if config['default_originate'] -%>
    announce default-route
      <%- end -%>
  }
      <%- end -%>
    <%- end -%>
  <%- end -%>
}
  <%- if config['inbound_routes'].to_s == 'all' then -%>
deny from group "AS<%= as %>" inet prefix 0.0.0.0/0 prefixlen = 0
  <%- @rejected_v4.each do |reject| -%>
deny from group "AS<%= as %>" inet prefix <%= reject %> prefixlen >= <%= reject.split('/')[1] %>
  <%- end -%>
deny from group "AS<%= as %>" inet prefixlen > 24
deny from group "AS<%= as %>" inet6 prefix ::/0 prefixlen = 0
  <%-  @rejected_v6.each do |reject| -%>
deny from group "AS<%= as %>" inet6 prefix <%= reject %> prefixlen >= <%= reject.split('/')[1] %>
  <%- end -%>
deny from group "AS<%= as %>" inet6 prefixlen > 48
  <%- elsif config['inbound_routes'].to_s == 'default' -%>
deny from group "AS<%= as %>"
allow from group "AS<%= as %>" inet prefix 0.0.0.0/0 prefixlen = 0
allow from group "AS<%= as %>" inet6 prefix ::/0 prefixlen = 0
  <%- elsif config['inbound_routes'].to_s == 'v6default' -%>
deny from group "AS<%= as %>"
allow from group "AS<%= as %>" inet6 prefix ::/0 prefixlen = 0
  <%- elsif config['inbound_routes'].to_s == 'v4default' -%>
deny from group "AS<%= as %>"
allow from group "AS<%= as %>" inet prefix 0.0.0.0/0 prefixlen = 0
  <%- else -%>
deny from group "AS<%= as %>"
  <%- end -%>
  <%- if config.has_key?('communities') then 
      #This should ensure no-export is always first if present
      config['communities'] = config['communities'].sort{ |x,y| y<=>x} 
    @nets.each do |net| -%>
match to group "AS<%= as %>" prefix <%= net %> set {
      <%- config['communities'].each do |community|
        if community.strip == 'no-export' then
          if @fail_nets.include?(net) -%>
  community NO_EXPORT<%- if community != config['communities'].last -%>, <%- end -%>
          <%- end
        else -%>
  community <%= community %><%- if community != config['communities'].last -%>, <%- end -%>
        <%- end 
      end -%>

}
    <%- end 
  end -%>
<%- end -%>
